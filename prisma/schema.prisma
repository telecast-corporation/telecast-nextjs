generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String          @id @default(cuid())
  email            String?         @unique
  name             String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  image            String?
  rssFeed          String?
  isPremium        Boolean         @default(false)
  premiumExpiresAt DateTime?
  usedFreeTrial    Boolean         @default(false)
  freeTrialEndedAt DateTime?       // Track when free trial ended for discount eligibility
  auth0Id          String?         @unique
  podcasts         Podcast[]
  platformConnections PlatformConnection[]
}

model Podcast {
  id             String          @id @default(cuid())
  title          String
  description    String?
  userId         String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  published      Boolean         @default(false)
  tags           String[]
  category       String
  language       String          @default("en")
  explicit       Boolean         @default(false)
  copyright      String?
  website        String?
  author         String
  coverImage     String?
  isPublic       Boolean         @default(false)
  rssFeed        String?
  episodes       Episode[]
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([title])
  @@index([category])
  @@index([tags])
}

model Episode {
  id            String    @id @default(cuid())
  podcastId     String
  audioUrl      String    // Required - stores file path in Google Cloud Storage
  
  // Optional metadata (filled during finalization)
  title         String?   // Episode title
  description   String?   // Episode description
  episodeNumber Int?      // Episode number in series
  seasonNumber  Int?      // Season number
  explicit      Boolean   @default(false)
  keywords      String[]  @default([])
  
  // Publishing info
  publishedAt   DateTime? // When episode was finalized/published
  isPublished   Boolean   @default(false) // Whether episode is finalized
  isFinal       Boolean   @default(false) // Whether episode has been finalized with metadata
  
  // File metadata
  duration      Int?      // Audio duration in seconds
  fileSize      Int?      // File size in bytes
  
  // Analytics
  views         Int       @default(0)
  likes         Int       @default(0)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  podcast       Podcast   @relation(fields: [podcastId], references: [id], onDelete: Cascade)

  @@index([podcastId])
  @@index([isPublished])
  @@index([publishedAt])
  @@index([isFinal])
}

model PlatformConnection {
  id           String    @id @default(cuid())
  userId       String
  platform     String    // 'spotify', 'apple', 'google'
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relations
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId])
  @@index([platform])
}
